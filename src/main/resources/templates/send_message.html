<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="https://www.thymeleaf.org">
<head>

    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.11.2/css/all.css" />
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" rel="stylesheet"/>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/4.3.0/mdb.min.css" rel="stylesheet"/>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" />
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/4.3.0/mdb.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.9/dist/js/bootstrap-select.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.9/dist/css/bootstrap-select.min.css">
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.9/dist/js/bootstrap-select.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>

</head>
<body>
<!--Main Navigation-->
<header>
    <!-- Intro settings -->
    <style>
        #intro {
            /*background-color: #e5e3dc;*/
            background-color: #D1FFFC;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100%25'%3E%3Cdefs%3E%3ClinearGradient id='a' gradientUnits='userSpaceOnUse' x1='0' x2='0' y1='0' y2='100%25' gradientTransform='rotate(355,960,480)'%3E%3Cstop offset='0' stop-color='%23D1FFFC'/%3E%3Cstop offset='1' stop-color='%23E3FFF0'/%3E%3C/linearGradient%3E%3Cpattern patternUnits='userSpaceOnUse' id='b' width='526' height='438.3' x='0' y='0' viewBox='0 0 1080 900'%3E%3Cg fill-opacity='0.04'%3E%3Cpolygon fill='%23444' points='90 150 0 300 180 300'/%3E%3Cpolygon points='90 150 180 0 0 0'/%3E%3Cpolygon fill='%23AAA' points='270 150 360 0 180 0'/%3E%3Cpolygon fill='%23DDD' points='450 150 360 300 540 300'/%3E%3Cpolygon fill='%23999' points='450 150 540 0 360 0'/%3E%3Cpolygon points='630 150 540 300 720 300'/%3E%3Cpolygon fill='%23DDD' points='630 150 720 0 540 0'/%3E%3Cpolygon fill='%23444' points='810 150 720 300 900 300'/%3E%3Cpolygon fill='%23FFF' points='810 150 900 0 720 0'/%3E%3Cpolygon fill='%23DDD' points='990 150 900 300 1080 300'/%3E%3Cpolygon fill='%23444' points='990 150 1080 0 900 0'/%3E%3Cpolygon fill='%23DDD' points='90 450 0 600 180 600'/%3E%3Cpolygon points='90 450 180 300 0 300'/%3E%3Cpolygon fill='%23666' points='270 450 180 600 360 600'/%3E%3Cpolygon fill='%23AAA' points='270 450 360 300 180 300'/%3E%3Cpolygon fill='%23DDD' points='450 450 360 600 540 600'/%3E%3Cpolygon fill='%23999' points='450 450 540 300 360 300'/%3E%3Cpolygon fill='%23999' points='630 450 540 600 720 600'/%3E%3Cpolygon fill='%23FFF' points='630 450 720 300 540 300'/%3E%3Cpolygon points='810 450 720 600 900 600'/%3E%3Cpolygon fill='%23DDD' points='810 450 900 300 720 300'/%3E%3Cpolygon fill='%23AAA' points='990 450 900 600 1080 600'/%3E%3Cpolygon fill='%23444' points='990 450 1080 300 900 300'/%3E%3Cpolygon fill='%23222' points='90 750 0 900 180 900'/%3E%3Cpolygon points='270 750 180 900 360 900'/%3E%3Cpolygon fill='%23DDD' points='270 750 360 600 180 600'/%3E%3Cpolygon points='450 750 540 600 360 600'/%3E%3Cpolygon points='630 750 540 900 720 900'/%3E%3Cpolygon fill='%23444' points='630 750 720 600 540 600'/%3E%3Cpolygon fill='%23AAA' points='810 750 720 900 900 900'/%3E%3Cpolygon fill='%23666' points='810 750 900 600 720 600'/%3E%3Cpolygon fill='%23999' points='990 750 900 900 1080 900'/%3E%3Cpolygon fill='%23999' points='180 0 90 150 270 150'/%3E%3Cpolygon fill='%23444' points='360 0 270 150 450 150'/%3E%3Cpolygon fill='%23FFF' points='540 0 450 150 630 150'/%3E%3Cpolygon points='900 0 810 150 990 150'/%3E%3Cpolygon fill='%23222' points='0 300 -90 450 90 450'/%3E%3Cpolygon fill='%23FFF' points='0 300 90 150 -90 150'/%3E%3Cpolygon fill='%23FFF' points='180 300 90 450 270 450'/%3E%3Cpolygon fill='%23666' points='180 300 270 150 90 150'/%3E%3Cpolygon fill='%23222' points='360 300 270 450 450 450'/%3E%3Cpolygon fill='%23FFF' points='360 300 450 150 270 150'/%3E%3Cpolygon fill='%23444' points='540 300 450 450 630 450'/%3E%3Cpolygon fill='%23222' points='540 300 630 150 450 150'/%3E%3Cpolygon fill='%23AAA' points='720 300 630 450 810 450'/%3E%3Cpolygon fill='%23666' points='720 300 810 150 630 150'/%3E%3Cpolygon fill='%23FFF' points='900 300 810 450 990 450'/%3E%3Cpolygon fill='%23999' points='900 300 990 150 810 150'/%3E%3Cpolygon points='0 600 -90 750 90 750'/%3E%3Cpolygon fill='%23666' points='0 600 90 450 -90 450'/%3E%3Cpolygon fill='%23AAA' points='180 600 90 750 270 750'/%3E%3Cpolygon fill='%23444' points='180 600 270 450 90 450'/%3E%3Cpolygon fill='%23444' points='360 600 270 750 450 750'/%3E%3Cpolygon fill='%23999' points='360 600 450 450 270 450'/%3E%3Cpolygon fill='%23666' points='540 600 630 450 450 450'/%3E%3Cpolygon fill='%23222' points='720 600 630 750 810 750'/%3E%3Cpolygon fill='%23FFF' points='900 600 810 750 990 750'/%3E%3Cpolygon fill='%23222' points='900 600 990 450 810 450'/%3E%3Cpolygon fill='%23DDD' points='0 900 90 750 -90 750'/%3E%3Cpolygon fill='%23444' points='180 900 270 750 90 750'/%3E%3Cpolygon fill='%23FFF' points='360 900 450 750 270 750'/%3E%3Cpolygon fill='%23AAA' points='540 900 630 750 450 750'/%3E%3Cpolygon fill='%23FFF' points='720 900 810 750 630 750'/%3E%3Cpolygon fill='%23222' points='900 900 990 750 810 750'/%3E%3Cpolygon fill='%23222' points='1080 300 990 450 1170 450'/%3E%3Cpolygon fill='%23FFF' points='1080 300 1170 150 990 150'/%3E%3Cpolygon points='1080 600 990 750 1170 750'/%3E%3Cpolygon fill='%23666' points='1080 600 1170 450 990 450'/%3E%3Cpolygon fill='%23DDD' points='1080 900 1170 750 990 750'/%3E%3C/g%3E%3C/pattern%3E%3C/defs%3E%3Crect x='0' y='0' fill='url(%23a)' width='100%25' height='100%25'/%3E%3Crect x='0' y='0' fill='url(%23b)' width='100%25' height='100%25'/%3E%3C/svg%3E");
            background-attachment: fixed;
            background-size: cover;
            height: 95vh;
        }

        /* Height for devices larger than 576px */
        @media (min-width: 992px) {
            #intro {
                margin-top: -58.59px;
            }
        }

        .navbar .nav-link {
            color: #544f4f !important;
        }
    </style>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white fixed-top">
        <div class="container-fluid">
            <!-- Navbar brand -->
            <a class="navbar-brand" target="_blank" href="https://mdbootstrap.com/docs/standard/">
                <img src="https://mdbootstrap.com/img/logo/mdb-transaprent-noshadows.png" height="16" alt="" loading="lazy"
                     style="margin-top: -3px;" />
            </a>
            <button class="navbar-toggler" type="button" data-mdb-toggle="collapse" data-mdb-target="#navbarExample01"
                    aria-controls="navbarExample01" aria-expanded="false" aria-label="Toggle navigation">
                <i class="fas fa-bars"></i>
            </button>
            <div class="collapse navbar-collapse" id="navbarExample01">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <label th:text="${username}"></label>
                </ul>
            </div>
        </div>
    </nav>
    <!-- Navbar -->
    <br><br><br>
    <div id="intro" class="p-5 text-center bg-light">
        <h1 class="mb-0 h4">List of All Messages</b></h1>
        <div class="container">
            <!--Grid row-->
            <div class="row" style="max-height: 90vh;">
                <div class="col-md-12 mb-12">
                    <section class="border-bottom mb-8">
                        <form class="bg-white  rounded-5 shadow-5-strong p-5" method="post" th:action="@{/send_message}" style="background-color: azure">
                            <select class="form-control selectpicker" id="receiverId" name="receiverId" data-live-search="true" required>
                                <option th:each="user : ${usersList}" th:value="${user.id}" th:text="${user.username}"> </option>
                            </select>

                            <div class="form-outline" style="margin-top: 30px">
                                <input class="form-control" id="theme" name="theme" rows="4" required/>
                                <label class="form-label" for="content">Theme</label>
                            </div>
                            <div class="form-outline" style="margin-top: 20px">
                                <textarea class="form-control" id="content" name="content" rows="4" required></textarea>
                                <label class="form-label" for="content">Message</label>
                            </div>
                            <button type="button" onclick="sendMessage()" class="btn btn-success">SEND</button>
                        </form>
                    </section>
                    <div class="container form-vertical" style="width: 100%; height: 50%;">
                        <section class="border-bottom mb-8">
                            <table class="table table-striped table-bordered" id="myTable">
                                <thead class="thead-dark">
                                <tr>
                                    <th style="width: 10%;">Sender</th>
                                    <th style="width: 20%;">Theme</th>
                                    <th style="width: 30%;">Content</th>
                                    <th style="width: 15%;">Date</th>
                                </tr>
                                </thead>
                                <tbody id="bodyTable">
                                <tr th:each="message: ${messagesList}">
                                    <td th:text="${message.senderUser.username}">Sender</td>
                                    <td class="theme" th:text="${message.theme}"><span class="click">Theme</span></td>
                                    <td class="content"th:text="${message.content}">Content</td>
                                    <td th:text="${message.sendDate}">Date</td>
                                </tr>
                                </tbody>

                            </table>
                        </section>
                    </div>
                </div>
            </div>
        </div>
    </div>
</header>
<main class="mt-4 mb-5">
    <!-- Modal -->
    <div class="modal fade" id="exampleModalLong" tabindex="-1" role="dialog" aria-labelledby="exampleModalLongTitle" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLongTitle">Message</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <label id="modal_textarea" name="modal_textarea"> </label>
                </div>
            </div>
        </div>
    </div>
</main>
<footer class="bg-light text-lg-start">
    <!-- Copyright -->
    <div class="text-center p-3" style="background-color: rgba(0, 0, 0, 0.2);">
        Â© 2022 Copyright:
        <a class="text-dark" href="#">Abbos Yuldoshev</a>
    </div>
    <!-- Copyright -->
</footer>
</body>
</html>
<style>
    thead, tbody { display: block; }

    tbody {
        height: 200px;       /* Just for the demo          */
        overflow-y: auto;    /* Trigger vertical scroll    */
        overflow-x: hidden;  /* Hide the horizontal scroll */
    }
    .form-outline .form-control {
        min-height: auto;
        padding: 0.33em 0.75em;
        border: 0;
        background: #00000014;
        transition: all .2s linear;
    }
</style>
<script>
    $( document ).ready(function() {
        $("#myTable").on('click', '.click', function() {
            var self = $(this).closest("tr");
            var content = self.find(".content").text();
            var theme = self.find(".theme").text();
            viewModal(content,theme);
        });
    });
    function sendMessage(){
        var selectId = $('#receiverId').val();
        var theme = $('#theme').val();
        var content = $('#content').val();
        var data = 'receiverId=' + selectId + '&theme=' + theme + '&content=' + content;
        if(theme.length == 0 || content.length == 0){
            alert("Theme or content is null");
            return;
        }

        $.ajax({
            url: "/send_message",
            type: "POST",
            data: data,
            success: function (response){
                console.log("response: " + JSON.stringify(response));
                $('#receiverId').val("");
                $('#theme').val("");
                $('#content').val("");
            },
            error: function (error){
                console.log("error: " + JSON.stringify(error));
            }
        });

        window.location.reload();
    }
    setInterval(function(){
        var data = "";
        $.ajax({
            url: "/list_message",
            type: "POST",
            data: data,
            success: function (response){
                $("#myTable > tbody").html("");
                for(var i=0;i<response.length;i++){
                    $('#myTable tbody').append('<tr>' +
                        '<td>' + response[i].senderUser.username + '</td>' +
                        '<td class="theme"><span class="click">' + response[i].theme + '</span></td>' +
                        '<td class="content">' + response[i].content + '</td>' +
                        '<td>' + response[i].sendDate + '</td>' +
                        '</tr>');
                }
            },
            error: function (error){
                console.log("list_message error: " + JSON.stringify(error));
            }
        });
    }, 5000);

    function viewModal(content, theme){
        console.log("content: " + content)
        var myModal = new bootstrap.Modal(document.getElementById("exampleModalLong"), {});
        $("#exampleModalLongTitle").text(theme);
        $("#modal_textarea").text(content);
        myModal.show();
    }

    $(function(){
        $('.row').click(function(){
            var $row = $(this).index();
        });
        $('.row .link').click(function(e){
            e.stopPropagation();
        });
    });
</script>